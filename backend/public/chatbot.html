<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Chatbot CHIDO</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="./assets/chatbot-icon.png" />
<style>
@keyframes pulseSlow {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
}
.animate-pulse-slow {
  animation: pulseSlow 2.5s infinite ease-in-out;
}

/* Limitar altura de burbujas y hacer scroll interno si es necesario */
#chat-window span.inline-block {
  max-height: 200px;
  overflow-y: auto;
  display: inline-block;
  white-space: pre-wrap;
}

/* Glow verde */
.glow-green {
  box-shadow: 0 0 15px rgba(34,197,94,0.7);
}
</style>
</head>
<body class="bg-gray-100">

<!-- Botón flotante para abrir el chatbot -->
<button id="open-chatbot-btn" class="fixed bottom-4 right-4 bg-green-600 hover:bg-green-700 text-white rounded-full p-3 shadow-lg transition hidden z-50">
  <img src="./assets/chatbot-icon.png" alt="Abrir chatbot" class="w-8 h-8">
</button>

<div id="chatbot-root" class="fixed bottom-4 right-4 w-[256px] max-h-[80vh] rounded-lg shadow-lg flex flex-col overflow-hidden z-50">
  <div class="flex items-center justify-between p-3 bg-green-600 text-white rounded-t-lg shadow-md">
    <div class="flex items-center space-x-2">
      <div class="relative">
        <img src="./assets/chatbot-icon.png" alt="Bot" class="rounded-full flex-shrink-0 border-2 border-white animate-pulse-slow">
        <span id="superchido-led" class="hidden absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-400 animate-ping"></span>
        <span id="superchido-led-solid" class="hidden absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-500"></span>
      </div>
      <span class="font-semibold text-lg">C.H.I.D.O.</span>
    </div>
    <button id="close-btn" class="text-white text-xl font-bold hover:text-gray-200 transition">&times;</button>
  </div>
  <div id="superchido-banner" class="hidden text-center text-green-700 font-bold p-2 bg-green-100 border-b border-green-400 animate-pulse">
    AHORA ESTÁS EN MODO SUPERCHIDO
  </div>
  <div id="chat-window" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gradient-to-b from-white to-gray-100"></div>
  <div class="p-3 border-t border-gray-300 bg-white flex space-x-2">
    <input id="user-input" type="text" placeholder="Escribe tu pregunta..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-400 transition" />
    <button id="send-btn" class="bg-green-500 hover:bg-green-600 text-white rounded-full px-4 py-2 transition">Enviar</button>
  </div>
</div>

<script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
const chatWindow = document.getElementById('chat-window');
const userInput = document.getElementById('user-input');
const closeBtn = document.getElementById('close-btn');
const openBtn = document.getElementById('open-chatbot-btn');
const sendBtn = document.getElementById('send-btn');

closeBtn.onclick = () => {
  document.getElementById('chatbot-root').style.display = 'none';
  openBtn.style.display = 'block';
};

openBtn.onclick = () => {
  document.getElementById('chatbot-root').style.display = 'flex';
  openBtn.style.display = 'none';
};

userInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter' && userInput.value.trim() !== '') {
    await sendMessage();
  }
});

sendBtn.onclick = async () => {
  if (userInput.value.trim() !== '') {
    await sendMessage();
  }
};

async function sendMessage() {
  const question = userInput.value.trim();
  appendMessage('Tú', question);
  userInput.value = '';
  await handleQuestion(question);
}

function appendMessage(sender, text) {
  const msg = document.createElement('div');
  msg.className = sender === 'Tú' ? 'text-right' : 'flex items-start space-x-2';
  if (sender === 'Tú') {
    msg.innerHTML = `<span class="inline-block px-3 py-2 rounded-lg bg-blue-500 text-white">${text}</span>`;
  } else {
    msg.innerHTML = `
      <img src="./assets/chatbot-icon.png" alt="Bot" class="w-6 h-6 rounded-full flex-shrink-0">
      <span class="inline-block px-3 py-2 rounded-lg bg-gray-200 text-gray-800">${text}</span>
    `;
  }
  chatWindow.appendChild(msg);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

let superchidoMode = false;

async function handleQuestion(question) {
  appendMessage('Bot', 'Pensando...');
  try {
    const response = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, superchido: superchidoMode })
    });
    const data = await response.json();
    console.log('Respuesta recibida del backend:', data);
    chatWindow.lastChild.remove();
    const answer = data.answer || 'No tengo una respuesta en este momento.';
    console.log('Mostrando respuesta:', answer);
    appendMessage('Bot', answer);

    // Si requiere aprobación para guardar
    if (data.pendingApproval) {
      const approveDiv = document.createElement('div');
      approveDiv.className = 'text-center mt-2';
      approveDiv.innerHTML = `
        <span class="text-sm">¿Guardar esta respuesta para futuras consultas?</span><br>
        <button class="mt-1 px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 mr-2" id="approve-btn">Sí</button>
        <button class="mt-1 px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" id="reject-btn">No</button>
      `;
      chatWindow.appendChild(approveDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      document.getElementById('approve-btn').onclick = async () => {
        try {
          await fetch('/save-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
          });
          approveDiv.innerHTML = '<span class="text-green-600 font-semibold">Respuesta guardada.</span>';
        } catch {
          approveDiv.innerHTML = '<span class="text-red-600 font-semibold">Error al guardar.</span>';
        }
      };

      document.getElementById('reject-btn').onclick = () => {
        approveDiv.remove();
      };
    }

    // Detectar modo SUPERCHIDO
    if (answer.includes('Modo chat abierto activado')) {
      superchidoMode = true;
      document.getElementById('superchido-banner').classList.remove('hidden');
      document.getElementById('superchido-led').classList.remove('hidden');
      document.getElementById('superchido-led-solid').classList.remove('hidden');
    }
  } catch (err) {
    console.error('Error consultando backend:', err);
    chatWindow.lastChild.remove();
    appendMessage('Bot', 'Error al conectar con el asistente.');
  }
}
</script>
</body>
</html>
